namespace PingCastle.Scanners
{
    using System;
    using System.Collections.Generic;
    using System.Diagnostics;
    using System.Runtime.InteropServices;
    using misc;
    using PingCastle.ADWS;
    using PingCastle.Healthcheck;
    using PingCastle.UserInterface;
    using PingCastleCommon.Utility;

    /// <summary>
    /// Scanner for detecting MS17-010 (EternalBlue/WannaCry) vulnerability protection status
    /// on domain controllers by analyzing SMB1 support and hotfix installation status.
    /// Scans multiple computers in a domain or specified computers for SMB1 support and MS17-010 patch status.
    /// </summary>
    /// <remarks>
    /// This scanner encapsulates the logic for determining whether a domain controller is vulnerable
    /// to MS17-010 by checking multiple factors: SMB1 support, installed hotfixes, operating system
    /// version, and system startup time.
    ///
    /// The scanner can operate in two modes:
    /// 1. Data-provided mode: All parameters are supplied (used by healthcheck rules)
    /// 2. On-demand retrieval mode: Only dcName is supplied, missing data is retrieved from the system
    /// </remarks>
    public class SmbHotFixVulnerabilityScanner : HotFixScanner
    {
        private readonly IWindowsNativeMethods _nativeMethods;

        /// <summary>
        /// MS17-010 security patches for various Windows versions.
        /// These patches address the EternalBlue/WannaCry vulnerability (CVE-2017-0144).
        /// Format: KB followed by number (e.g., "KB4012598").
        /// </summary>
        private static readonly string[] Ms17010KBs =
        {
            "KB4012598",
            "KB4012212",
            "KB4012213",
            "KB4012214",
            "KB4012215",
            "KB4012216",
            "KB4012217",
            "KB4012606",
            "KB4013389",
            "KB4013429",
        };

        /// <summary>
        /// MS17-010 security bulletin release date (March 14, 2017).
        /// Systems with startup time before this date are considered potentially vulnerable
        /// if SMB1 is enabled and hotfix status is unknown.
        /// </summary>
        private static readonly DateTime AlertDate = new DateTime(2017, 03, 14);

        public SmbHotFixVulnerabilityScanner(IHotFixCollector hotfixCollector, IOperatingSystemInfoProvider osInfoProvider, IWindowsNativeMethods nativeMethods, IIdentityProvider identityProvider)
            : base(hotfixCollector, osInfoProvider, identityProvider)
        {
            _nativeMethods = nativeMethods;
        }

        public override string Name { get { return "smbhotfix"; } }

        public override string Description
        {
            get { return "Check MS17-010 (EternalBlue/WannaCry) vulnerability status. Analyzes SMB1 support and installed security patches."; }
        }

        override protected string GetCsvHeader()
        {
            return "Computer\tIsVulnerable\tReason\tOperatingSystem";
        }

        override protected string GetCsvData(string computer)
        {
            try
            {
                var result = Scan(computer);

                if (result != null)
                {
                    string vulnerable = result.IsVulnerable ? "Yes" : "No";
                    string reason = result.Reason ?? "Unknown";
                    string operatingSystem = OperatingSystemHelper.GetOperatingSystem(result.OSVersion);
                    return $"{computer}\t{vulnerable}\t{reason}\t{operatingSystem}";
                }

                return null;
            }
            catch (Exception ex)
            {
                Trace.WriteLine($"Error scanning {computer}: {ex.Message}");
                return $"{computer}\tError\t{ex.Message}\tN/A";
            }
        }

        /// <summary>
        /// Scans a computer for MS17-010 vulnerability status.
        /// </summary>
        /// <param name="computerName">The computer name (required; used for diagnostics and data retrieval if other parameters are not provided)</param>
        /// <param name="operatingSystem">The operating system identifier of the computer
        ///     (e.g., "Windows Server 2016", "Windows Server 2019", "Windows Server 2022", "Windows Server 2025"),
        ///     or null to retrieve from the system</param>
        /// <param name="supportSMB1">Whether SMB1 is supported/enabled on the DC.
        ///     If false, the system is considered not vulnerable regardless of other factors.
        ///     If not provided (null), will be detected from the system.</param>
        /// <param name="installedHotfixes">The collection of installed hotfix KB numbers (e.g., "KB4012598"),
        ///     or null/empty to retrieve from the system</param>
        /// <param name="startupTime">The startup time of the computer.
        ///     Used as a heuristic when hotfix status is unknown.
        ///     If not provided (null), will be retrieved from the system.</param>
        /// <returns>A ScanResult containing vulnerability status and reason for the determination</returns>
        /// <exception cref="ArgumentNullException">Thrown if computerName is null or empty</exception>
        public ScanResult Scan(
            string computerName,
            string operatingSystem = null,
            bool? supportSMB1 = null,
            HashSet<string> installedHotfixes = null,
            DateTime? startupTime = null)
        {
            if (string.IsNullOrEmpty(computerName))
            {
                throw new ArgumentNullException(nameof(computerName), "Computer name is required");
            }

            // Retrieve missing parameters from the system
            operatingSystem = operatingSystem ?? RetrieveOperatingSystem(computerName);
            supportSMB1 = supportSMB1 ?? RetrieveSMB1Support(computerName);
            installedHotfixes = installedHotfixes ?? RetrieveInstalledHotfixes(computerName);
            startupTime = startupTime ?? RetrieveStartupTime(computerName);

            // Perform vulnerability analysis with retrieved/provided data
            return AnalyzeVulnerability(computerName, operatingSystem, supportSMB1 ?? false, installedHotfixes, startupTime.Value);
        }

        /// <summary>
        /// Retrieves SMB1 support status for a domain controller by attempting an SMB1 connection.
        /// </summary>
        /// <param name="dcName">The domain controller name</param>
        /// <returns>True if SMB1 is supported; false otherwise</returns>
        private bool RetrieveSMB1Support(string dcName)
        {
            try
            {
                // Use SmbScanner to detect SMB1 support
                SMBSecurityModeEnum securityMode;
                bool supportsSMB1 = SmbScanner.SupportSMB1(dcName, out securityMode, "");
                Trace.WriteLine($"SMB1 support for {dcName}: {supportsSMB1}");
                return supportsSMB1;
            }
            catch (Exception ex)
            {
                Trace.WriteLine($"Error detecting SMB1 support for {dcName}: {ex.Message}");
                // Default to true (assume vulnerable) if we can't determine
                return true;
            }
        }


        /// <summary>
        /// Retrieves the startup time for a domain controller.
        /// </summary>
        /// <param name="dcName">The domain controller name</param>
        /// <returns>The startup time, or DateTime.MinValue if retrieval fails or on non-Windows systems</returns>
        private DateTime RetrieveStartupTime(string dcName)
        {
            if (!RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
            {
                Trace.WriteLine($"Startup time retrieval not supported on non-Windows platform for {dcName}");
                return DateTime.MinValue;
            }

            try
            {
                DateTime startupTime = _nativeMethods.GetStartupTime(dcName);
                if (startupTime != DateTime.MinValue)
                {
                    Trace.WriteLine($"Retrieved startup time for {dcName}: {startupTime}");
                    return startupTime;
                }

                Trace.WriteLine($"Unable to retrieve startup time for {dcName}");
                return DateTime.MinValue;
            }
            catch (Exception ex)
            {
                Trace.WriteLine($"Error retrieving startup time for {dcName}: {ex.Message}");
                return DateTime.MinValue;
            }
        }

        /// <summary>
        /// Internal method that performs the vulnerability analysis given all required parameters.
        /// </summary>
        private ScanResult AnalyzeVulnerability(
            string dcName,
            string operatingSystem,
            bool supportSMB1,
            HashSet<string> installedHotfixes,
            DateTime startupTime)
        {
            // Implicitly patched if SMB1 is not supported
            if (!supportSMB1)
            {
                return new ScanResult
                {
                    IsVulnerable = false,
                    Reason = "SMB1 is disabled or not supported",
                    OSVersion = operatingSystem
                };
            }

            // Implicitly patched on Windows Server 2019 and later (SMB1 not installed by default)
            if (IsModernWindowsServer(operatingSystem))
            {
                return new ScanResult
                {
                    IsVulnerable = false,
                    Reason = $"Operating system {operatingSystem} has SMB1 disabled by default",
                    OSVersion = operatingSystem
                };
            }

            // Check for MS17-010 hotfixes if available
            if (installedHotfixes != null && installedHotfixes.Count > 0)
            {
                if (HasMs17010Patch(installedHotfixes))
                {
                    return new ScanResult
                    {
                        IsVulnerable = false,
                        Reason = "MS17-010 patch is installed",
                        OSVersion = operatingSystem
                    };
                }

                return new ScanResult
                {
                    IsVulnerable = true,
                    Reason = "SMB1 enabled without MS17-010 patch",
                    OSVersion = operatingSystem
                };
            }

            // No hotfix information available - use startup time as heuristic
            if (startupTime != DateTime.MinValue && startupTime < AlertDate)
            {
                return new ScanResult
                {
                    IsVulnerable = true,
                    Reason = $"SMB1 enabled and StartupTime={startupTime}",
                    OSVersion = operatingSystem
                };
            }

            // Check for legacy operating systems
            if (operatingSystem == "Windows 2000" || operatingSystem == "Windows NT")
            {
                return new ScanResult
                {
                    IsVulnerable = true,
                    Reason = "SMB1 enabled on legacy Operating System",
                    OSVersion = operatingSystem
                };
            }

            // Hotfix status is unknown
            return new ScanResult
            {
                IsVulnerable = true,
                Reason = "SMB1 enabled and hotfix status unknown",
                OSVersion = operatingSystem
            };
        }

        /// <summary>
        /// Determines if the operating system version has SMB1 disabled by default.
        /// Windows Server 2019 and later versions do not install SMB1 by default,
        /// making systems implicitly protected from MS17-010.
        /// </summary>
        /// <param name="operatingSystem">The operating system identifier</param>
        /// <returns>True if the OS has SMB1 disabled by default; otherwise false</returns>
        private bool IsModernWindowsServer(string operatingSystem)
        {
            if (string.IsNullOrEmpty(operatingSystem))
            {
                return false;
            }

            return operatingSystem.Contains("2019")
                || operatingSystem.Contains("2022")
                || operatingSystem.Contains("2025");
        }

        /// <summary>
        /// Checks if the machine has one of the known MS17-010 patches installed.
        /// Iterates through the list of known MS17-010 KB articles and checks for matches
        /// in the provided hotfixes collection.
        /// </summary>
        /// <param name="installedHotfixes">The collection of installed hotfix KB numbers</param>
        /// <returns>True if at least one MS17-010 patch is found; otherwise false</returns>
        private bool HasMs17010Patch(HashSet<string> installedHotfixes)
        {
            foreach (var kb in Ms17010KBs)
            {
                if (installedHotfixes.Contains(kb))
                {
                    Trace.WriteLine($"MS17-010 patch detected: {kb}");
                    return true;
                }
            }

            return false;
        }

        /// <summary>
        /// Result of an MS17-010 vulnerability scan on a system.
        /// Contains the determination of vulnerability status and a human-readable explanation.
        /// </summary>
        public class ScanResult
        {
            /// <summary>
            /// Gets or sets a value indicating whether the machine is vulnerable to MS17-010.
            /// True means the system may be exploitable; false means the system is protected.
            /// </summary>
            public bool IsVulnerable { get; set; }

            /// <summary>
            /// Gets or sets the reason for the vulnerability determination.
            /// This is a descriptive message explaining why the system is or is not vulnerable
            /// (e.g., "SMB1 enabled without MS17-010 patch" or "MS17-010 patch is installed").
            /// </summary>
            public string Reason { get; set; }

            /// <summary>
            /// Version of the OS found when scanned.
            /// </summary>
            public string OSVersion { get; set; }
        }
    }
}
