namespace PingCastle.Scanners
{
    using PingCastle.ADWS;
    using PingCastle.Healthcheck;
    using PingCastle.misc;
    using PingCastleCommon.Utility;
    using System;
    using System.Collections.Generic;
    using System.Diagnostics;
    using System.Linq;
    using System.Runtime.InteropServices;

    /// <summary>
    /// Scanner for detecting MS14-068 (CVE-2014-6324) Kerberos vulnerability protection status on computers.
    /// Determines scan result as either 'Not Vulnerable', 'Vulnerable', or 'Critically Vulnerable' based on
    /// operating system version, installed hotfixes, and startup time.
    /// </summary>
    /// <remarks>
    /// MS14-068 addresses a Kerberos checksum validation vulnerability that allows privilege escalation.
    /// The vulnerability is critical for Windows Server 2003, 2008, 2008 R2, 2012, and 2012 R2.
    /// Windows Vista, Windows 7, Windows 8, and Windows 8.1 receive defense-in-depth updates only.
    ///
    /// This scanner operates in two modes:
    /// 1. Data-provided mode: All parameters are supplied (used by health-check rules)
    /// 2. On-demand retrieval mode: Only dcName is supplied, missing data is retrieved from the system
    /// </remarks>
    public class KerberosChecksumVulnerabilityScanner : HotFixScanner
    {
        private readonly IWindowsNativeMethods _nativeMethods;

        /// <summary>
        /// KB3011780 security hotfix identifier.
        /// Addresses the Kerberos checksum validation vulnerability (CVE-2014-6324).
        /// </summary>
        private const string Kb3011780 = "KB3011780";

        /// <summary>
        /// Reason message: KB3011780 patch is installed.
        /// </summary>
        private const string ReasonPatchInstalled = "KB3011780 patch is installed";

        /// <summary>
        /// Reason message: KB3011780 patch is not installed.
        /// </summary>
        private const string ReasonPatchNotInstalled = "KB3011780 patch is not installed";

        /// <summary>
        /// Reason message: KB3011780 patch status unknown.
        /// </summary>
        private const string ReasonStatusUnknown = "KB3011780 patch status unknown";

        /// <summary>
        /// KB3011780 release date (November 18, 2014).
        /// Systems with startup time before this date are considered potentially vulnerable
        /// if hotfix status is unknown and OS is affected.
        /// </summary>
        private static readonly DateTime AlertDate = new DateTime(2014, 11, 18);

        /// <summary>
        /// Operating system version patterns that are CRITICALLY vulnerable to MS14-068.
        /// Per MS14-068 bulletin, the Kerberos checksum vulnerability is critical for these server versions.
        /// Requires KB3011780 hotfix to be secure.
        /// </summary>
        private static readonly HashSet<string> CriticallyVulnerableOsPatterns = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "2003",
            "2008",
            "2012"
        };

        /// <summary>
        /// Operating system version patterns that receive DEFENSE-IN-DEPTH updates for MS14-068.
        /// Per MS14-068 bulletin, these client OS versions are vulnerable and receive defense-in-depth hardening.
        /// KB3011780 provides additional hardening even though the vulnerability is not actively exploitable.
        /// </summary>
        private static readonly HashSet<string> DefenseInDepthVulnerableOsPatterns = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "Vista",
            "Windows 7",
            "Windows 8",
            "Windows 8.1"
        };

        /// <summary>
        /// Operating system version patterns that are NOT vulnerable to MS14-068.
        /// Per MS14-068 bulletin, these OS versions released after the vulnerability was fixed
        /// or are unaffected by the Kerberos checksum validation vulnerability.
        /// </summary>
        private static readonly HashSet<string> NonVulnerableOsPatterns = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "Windows 10",
            "Windows 11",
            "2016",
            "2019",
            "2022",
            "2025"
        };

        public KerberosChecksumVulnerabilityScanner(IHotFixCollector hotfixCollector, IOperatingSystemInfoProvider osInfoProvider, IWindowsNativeMethods nativeMethods, IIdentityProvider identityProvider)
            : base(hotfixCollector, osInfoProvider, identityProvider)
        {
            _nativeMethods = nativeMethods;
        }

        public override string Name => "kerberoschecksumhotfix";

        public override string Description => "Check MS14-068 vulnerability. Analyses KB3011780 installation status.";

        protected override string GetCsvHeader() => "Computer\tIsVulnerable\tReason\tOperatingSystem";

        protected override string GetCsvData(string computer)
        {
            try
            {
                var result = Scan(computer);

                if (result != null)
                {
                    string securityLevel = result.SeverityLevel ?? "Unknown";
                    string reason = result.Reason ?? "Unknown";
                    string operatingSystem = OperatingSystemHelper.GetOperatingSystem(result.OsVersion);
                    return $"{computer}\t{securityLevel}\t{reason}\t{operatingSystem}";
                }

                return null;
            }
            catch (Exception ex)
            {
                Trace.WriteLine($"Error scanning {computer}: {ex.Message}");
                return $"{computer}\tError\t{ex.Message}\tN/A";
            }
        }

        /// <summary>
        /// Scans a computer for MS14-068 (CVE-2014-6324) Kerberos vulnerability protection status.
        /// </summary>
        /// <param name="computerName">The computer name (required; used for diagnostics and data retrieval if other parameters are not provided)</param>
        /// <param name="operatingSystem">The operating system identifier of the computer
        ///     (e.g., "Windows Server 2003", "Windows Server 2008", "Windows Server 2012").
        ///     Systems with Vista, Windows 7, 8, or 8.1 are not vulnerable. Or null to retrieve from the system.</param>
        /// <param name="installedHotfixes">The collection of installed hotfix KB numbers (e.g., "KB3011780"),
        ///     or null/empty to retrieve from the system</param>
        /// <param name="startupTime">The startup time of the computer.
        ///     Used as a heuristic when hotfix status is unknown.
        ///     If not provided (null), will be retrieved from the system.</param>
        /// <returns>A ScanResult containing vulnerability status and reason for the determination</returns>
        /// <exception cref="ArgumentNullException">Thrown if computerName is null or empty</exception>
        public ScanResult Scan(
            string computerName,
            string operatingSystem = null,
            HashSet<string> installedHotfixes = null,
            DateTime? startupTime = null)
        {
            if (string.IsNullOrEmpty(computerName))
            {
                throw new ArgumentNullException(nameof(computerName), "Computer name is required");
            }

            operatingSystem ??= RetrieveOperatingSystem(computerName);
            installedHotfixes ??= RetrieveInstalledHotfixes(computerName);
            startupTime ??= RetrieveStartupTime(computerName);

            return AnalyzeVulnerability(operatingSystem, installedHotfixes, startupTime.Value);
        }

        /// <summary>
        /// Retrieves the startup time for a domain controller.
        /// </summary>
        /// <param name="dcName">The domain controller name</param>
        /// <returns>The startup time, or DateTime.MinValue if retrieval fails</returns>
        private DateTime RetrieveStartupTime(string dcName)
        {
            if (!RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
            {
                Trace.WriteLine($"Startup time retrieval not supported on non-Windows platform for {dcName}");
                return DateTime.MinValue;
            }

            try
            {
                DateTime startupTime = _nativeMethods.GetStartupTime(dcName);
                if (startupTime != DateTime.MinValue)
                {
                    Trace.WriteLine($"Retrieved startup time for {dcName}: {startupTime}");
                    return startupTime;
                }

                Trace.WriteLine($"Unable to retrieve startup time for {dcName}");
                return DateTime.MinValue;
            }
            catch (Exception ex)
            {
                Trace.WriteLine($"Error retrieving startup time for {dcName}: {ex.Message}");
                return DateTime.MinValue;
            }
        }

        /// <summary>
        /// Internal method that performs the vulnerability analysis given all required parameters.
        /// Per MS14-068 bulletin:
        /// - Critical: Windows Server 2003, 2008, 2008 R2, 2012, 2012 R2 (elevation of privilege vulnerability)
        /// - Vulnerable: Windows Vista, 7, 8, 8.1 (defense-in-depth hardening only)
        /// - Non-Vulnerable: Windows 10, 11, Server 2016+ (unaffected by vulnerability)
        /// </summary>
        private ScanResult AnalyzeVulnerability(
            string operatingSystem,
            HashSet<string> installedHotfixes,
            DateTime startupTime)
        {
            if (IsNonVulnerableOperatingSystem(operatingSystem))
            {
                return new ScanResult
                {
                    IsVulnerable = false,
                    Reason = $"Operating system {operatingSystem} is not vulnerable to MS14-068",
                    OsVersion = operatingSystem,
                    SeverityLevel = "No"
                };
            }

            if (installedHotfixes != null && installedHotfixes.Count > 0)
            {
                if (installedHotfixes.Contains(Kb3011780))
                {
                    return new ScanResult
                    {
                        IsVulnerable = false,
                        Reason = ReasonPatchInstalled,
                        OsVersion = operatingSystem,
                        SeverityLevel = "No"
                    };
                }

                bool isCritical = IsCriticalOperatingSystem(operatingSystem);
                string severity = isCritical ? "Critical" : "Yes";
                return new ScanResult
                {
                    IsVulnerable = true,
                    Reason = ReasonPatchNotInstalled,
                    OsVersion = operatingSystem,
                    SeverityLevel = severity
                };
            }

            bool isCriticalFinalCheck = IsCriticalOperatingSystem(operatingSystem);
            if (startupTime != DateTime.MinValue && startupTime < AlertDate)
            {
                string severity = isCriticalFinalCheck ? "Critical" : "Yes";
                return new ScanResult
                {
                    IsVulnerable = true,
                    Reason = $"KB3011780 patch status unknown and StartupTime={startupTime:G}",
                    OsVersion = operatingSystem,
                    SeverityLevel = severity
                };
            }

            string finalSeverity = isCriticalFinalCheck ? "Critical" : "Yes";
            return new ScanResult
            {
                IsVulnerable = true,
                Reason = ReasonStatusUnknown,
                OsVersion = operatingSystem,
                SeverityLevel = finalSeverity
            };
        }

        /// <summary>
        /// Determines if the operating system version is NOT vulnerable to MS14-068.
        /// These operating systems are unaffected by the Kerberos checksum validation vulnerability.
        /// </summary>
        /// <param name="operatingSystem">The operating system identifier</param>
        /// <returns>True if the OS is not vulnerable; false otherwise</returns>
        private bool IsNonVulnerableOperatingSystem(string operatingSystem)
        {
            if (string.IsNullOrEmpty(operatingSystem))
            {
                return false;
            }

            return ContainsPattern(operatingSystem, NonVulnerableOsPatterns);
        }

        /// <summary>
        /// Determines if the operating system version is vulnerable to MS14-068.
        /// Includes both critically vulnerable server OS and defense-in-depth vulnerable client OS.
        /// </summary>
        /// <param name="operatingSystem">The operating system identifier</param>
        /// <returns>True if the OS is potentially vulnerable; false if it is known to be not vulnerable</returns>
        private bool IsVulnerableOperatingSystem(string operatingSystem)
        {
            if (string.IsNullOrEmpty(operatingSystem))
            {
                return false;
            }

            bool isCritical = ContainsPattern(operatingSystem, CriticallyVulnerableOsPatterns);
            bool isDefenseInDepth = ContainsPattern(operatingSystem, DefenseInDepthVulnerableOsPatterns);

            return isCritical || isDefenseInDepth;
        }

        /// <summary>
        /// Checks if an operating system string contains any of the specified patterns.
        /// Uses case-insensitive substring matching.
        /// </summary>
        /// <param name="operatingSystem">The operating system identifier to check</param>
        /// <param name="patterns">The collection of patterns to search for</param>
        /// <returns>True if any pattern is found in the operating system string; otherwise false</returns>
        private bool ContainsPattern(string operatingSystem, HashSet<string> patterns)
        {
            return patterns.Any(pattern =>
                operatingSystem.IndexOf(pattern, StringComparison.OrdinalIgnoreCase) >= 0);
        }

        /// <summary>
        /// Determines if the operating system version is critically vulnerable to MS14-068.
        /// Checks against the configured list of critically vulnerable OS patterns.
        /// </summary>
        /// <param name="operatingSystem">The operating system identifier</param>
        /// <returns>True if the OS has a critical vulnerability to MS14-068; otherwise false</returns>
        private bool IsCriticalOperatingSystem(string operatingSystem)
        {
            if (string.IsNullOrEmpty(operatingSystem))
            {
                return false;
            }

            return ContainsPattern(operatingSystem, CriticallyVulnerableOsPatterns);
        }

        /// <summary>
        /// Result of a MS14-068 vulnerability scan on a system.
        /// Contains the determination of vulnerability status and a human-readable explanation.
        /// </summary>
        public class ScanResult
        {
            /// <summary>
            /// Gets or sets a value indicating whether the machine is vulnerable to MS14-068.
            /// True means the system may be exploitable; false means not vulnerable or patched.
            /// </summary>
            public bool IsVulnerable { get; set; }

            /// <summary>
            /// Gets or sets the reason for the vulnerability determination.
            /// This is a descriptive message explaining why the system is or is not vulnerable
            /// (e.g., "KB3011780 patch is installed", "Operating system is not vulnerable to MS14-068").
            /// </summary>
            public string Reason { get; set; }

            /// <summary>
            /// Version of the OS found when scanned.
            /// </summary>
            public string OsVersion { get; set; }

            /// <summary>
            /// Gets or sets the severity level of the vulnerability.
            /// "No" if not vulnerable, "Critical" if critically vulnerable, "Yes" if vulnerable but not critical.
            /// Cached to avoid redundant OS version re-analysis.
            /// </summary>
            public string SeverityLevel { get; set; }
        }
    }
}
